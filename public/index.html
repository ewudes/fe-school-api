<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <title>Zenktra API Panel</title>
  </head>
  <body class="vh-100">
    <div class="container-fluid h-100">
      <div id="auth-block" class="col-sm-2 position-absolute top-50 start-50 translate-middle">
        <div class="form-group">
          <label for="username">Логин:</label>
          <input class="form-control" id="username" />
        </div>
        <div class="form-group">
          <label for="password">Пароль:</label>
          <input type="password" class="form-control" id="password" />
        </div>
        <div class="panel-body">
          <button id="loginBtn" class="btn btn-sm btn-success mt-3">Войти</button>
          <button id="registerBtn" class="btn btn-sm btn-info mt-3 ms-1">
            Зарегистрировать
          </button>
        </div>
        <div id="auth-status" style="margin-top: 10px"></div>
      </div>

      <div class="row mt-4 overflow-x-hidden" id="eventRow">
        <div class="event-form" style="display: none" id="logout-block">
          <button id="logoutBtn" class="btn btn-sm btn-danger ms-auto mb-3">Выйти</button>
        </div>
        <div class="col-sm-4">
          <form
            name="eventForm"
            id="eventForm"
            class="px-3"
            style="display: none"
          >
            <input type="hidden" name="id" value="0" />
            <div class="form-group">
              <label for="theme">Тема:</label>
              <input class="form-control" name="theme" />
            </div>
            <div class="form-group">
              <label for="comment">Комментарий:</label>
              <input class="form-control" name="comment" />
            </div>
            <div class="form-group">
              <label for="executor">Исполнитель:</label>
              <select class="form-control" name="executor" id="executor">
                <option value="">Выберите исполнителя</option>
              </select>
            </div>
            <div class="form-group">
              <label for="date">Дата:</label>
              <input
                type="datetime-local"
                class="form-control form-control__date"
                name="date"
              />
            </div>
            <div class="form-group">
              <label for="favorite" class="form-label__checkbox"
                >Избранное</label
              >
              <input
                type="checkbox"
                class="form-control form-control__checkbox"
                name="favorite"
              />
            </div>
            <div class="form-group">
              <label for="archive" class="form-label__checkbox">Архив</label>
              <input
                type="checkbox"
                class="form-control form-control__checkbox"
                name="archive"
              />
            </div>
            <div class="panel-body">
              <button type="submit" class="btn btn-sm btn-primary">
                Сохранить
              </button>
              <a id="reset" class="btn btn-sm btn-primary">Сбросить</a>
            </div>
          </form>
        </div>

        <div class="col-sm-8 overflow-x-auto">
          <table
            class="table table-condensed table-striped table-bordered col-sm-1"
            style="display: none"
          >
            <thead>
              <tr>
                <th>Id</th>
                <th>Тема</th>
                <th>Комментарий</th>
                <th>Автор</th>
                <th>Дата</th>
                <th>Исполнитель</th>
                <th>F</th>
                <th>A</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
      let authToken = localStorage.getItem('token') || '';

      const authBlock = document.getElementById('auth-block');
      const eventRow = document.getElementById('eventRow');
      const eventForm = document.getElementById('eventForm');
      const eventTable = document.querySelector('table');
      const logoutBlock = document.getElementById('logout-block');

      if (!authToken) {
        authBlock.style.display = 'block';
        eventRow.style.display = 'none';
      } else {
        authBlock.style.display = 'none';
        eventForm.style.display = 'block';
        eventTable.style.display = 'table';
        logoutBlock.style.display = 'flex';
        GetEvents();
        LoadExecutors();
      }

      async function LoadExecutors() {
        const response = await fetch('/api/users', {
          method: 'GET',
          headers: {
            Accept: 'application/json',
            Authorization: 'Bearer ' + authToken,
          },
        });

        if (response.ok) {
          const users = await response.json();
          const select = document.getElementById('executor');
          select.innerHTML = '<option value="">Выберите исполнителя</option>';
          users.forEach((user) => {
            const option = document.createElement('option');
            option.value = user.login;
            option.textContent = user.login;
            select.appendChild(option);
          });
        }
      }

      document
        .getElementById('loginBtn')
        .addEventListener('click', async () => {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (res.ok) {
            authToken = data.token;
            localStorage.setItem('token', authToken);
            document.getElementById('auth-status').textContent =
              'Login successful!';
            authBlock.style.display = 'none';
            eventForm.style.display = 'block';
            eventTable.style.display = 'table';
            logoutBlock.style.display = 'block';
            GetEvents();
            LoadExecutors();
          } else {
            document.getElementById('auth-status').textContent =
              data.message || 'Login failed';
          }
        });

      document
        .getElementById('registerBtn')
        .addEventListener('click', async () => {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById('auth-status').textContent =
              'Registration successful!';
          } else {
            document.getElementById('auth-status').textContent =
              data.message || 'Registration failed';
          }
        });

      document.getElementById('logoutBtn').addEventListener('click', logout);

      function logout() {
        localStorage.removeItem('token');
        location.reload();
      }

      async function SecureFetch(url, options = {}) {
        const token = localStorage.getItem('token');

        const res = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
            ...options.headers
          }
        });

        if (res.status === 401) {
          alert('Сессия истекла. Пожалуйста, войдите снова.');
          logout();
          return null;
        }

        return res;
      };

      async function GetEvents() {
        const res = await SecureFetch('/api/events');
        if (!res) return;
          
        const events = await res.json();
        let rows = document.querySelector('tbody');
        rows.innerHTML = '';
        events.forEach((event) => {
          rows.append(row(event));
        });
      }

      async function GetEvent(id) {
        const response = await fetch('/api/events/' + id, {
          method: 'GET',
          headers: {
            Accept: 'application/json',
            Authorization: 'Bearer ' + authToken,
          },
        });
        if (response.ok === true) {
          const event = await response.json();
          const form = document.forms['eventForm'];
          form.elements['id'].value = event._id;
          form.elements['theme'].value = event.theme;
          form.elements['comment'].value = event.comment;
          form.elements['date'].value = event.date;
          form.elements['favorite'].checked = event.favorite;
          form.elements['archive'].checked = event.archive;
          form.elements['executor'].value = event.executor || '';
        }
      }

      async function CreateEvent(
        theme,
        comment,
        author,
        date,
        favorite,
        archive,
        executor
      ) {
        const response = await fetch('/api/events', {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + authToken,
          },
          body: JSON.stringify({
            theme,
            comment,
            author,
            date,
            favorite,
            archive,
            executor,
          }),
        });
        if (response.ok === true) {
          const event = await response.json();
          reset();
          document.querySelector('tbody').append(row(event));
        }
      }

      async function EditEvent(
        id,
        theme,
        comment,
        date,
        favorite,
        archive,
        executor
      ) {
        const response = await fetch('/api/events', {
          method: 'PUT',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + authToken,
          },
          body: JSON.stringify({
            id,
            theme,
            comment,
            date,
            favorite,
            archive,
            executor,
          }),
        });
        if (response.ok === true) {
          const event = await response.json();
          reset();
          document
            .querySelector("tr[data-rowid='" + event._id + "']")
            .replaceWith(row(event));
        }
      }

      async function DeleteEvent(id) {
        const response = await fetch('/api/events/' + id, {
          method: 'DELETE',
          headers: {
            Accept: 'application/json',
            Authorization: 'Bearer ' + authToken,
          },
        });
        if (response.ok === true) {
          const event = await response.json();
          document.querySelector("tr[data-rowid='" + event._id + "']").remove();
        }
      }

      function reset() {
        const form = document.forms['eventForm'];
        form.reset();
        form.elements['id'].value = 0;
      }

      function row(event) {
        const tr = document.createElement('tr');
        tr.setAttribute('data-rowid', event._id);

        tr.innerHTML = `
          <td>${event._id}</td>
          <td>${event.theme}</td>
          <td>${event.comment}</td>
          <td>${event.author}</td>
          <td>${event.date}</td>
          <td>${event.executor}</td>
          <td>${event.favorite}</td>
          <td>${event.archive}</td>
          <td>
            <a href="#" data-id="${event._id}" class="edit-link" style="padding:15px;">Change</a>
            <a href="#" data-id="${event._id}" class="delete-link" style="padding:15px;color:#FF0000">Delete</a>
          </td>
        `;

        tr.querySelector('.edit-link').addEventListener('click', (e) => {
          e.preventDefault();
          GetEvent(event._id);
        });
        tr.querySelector('.delete-link').addEventListener('click', (e) => {
          e.preventDefault();
          DeleteEvent(event._id);
        });

        return tr;
      }

      document.getElementById('reset').addEventListener('click', (e) => {
        e.preventDefault();
        reset();
      });

      document.forms['eventForm'].addEventListener('submit', (e) => {
        e.preventDefault();
        const form = document.forms['eventForm'];
        const id = form.elements['id'].value;
        const theme = form.elements['theme'].value;
        const comment = form.elements['comment'].value;
        const date = form.elements['date'].value || new Date().toISOString();
        const favorite = form.elements['favorite'].checked;
        const archive = form.elements['archive'].checked;
        const executor = form.elements['executor'].value;

        if (id == 0)
          CreateEvent(theme, comment, date, favorite, archive, executor);
        else EditEvent(id, theme, comment, date, favorite, archive, executor);
      });
    </script>
  </body>
</html>
