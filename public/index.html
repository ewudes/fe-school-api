<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
    <title>FE School API</title>
    <style>
        .event-form {
            padding: 20px;
        }
        .table {
            width: 96%;
            margin: auto;
        }
        .panel-body {
            padding: 0;
        }
        .form-control__date {
            width: 200px;
        }
        .form-control__checkbox {
            display: inline-block;
            width: 15px;
            height: 15px;
        }
        .form-label__checkbox {
            vertical-align: top;
        }
    </style>
</head>
<body>
    <!-- Авторизация -->
    <div id="auth-block" class="event-form">
        <h3>Login / Register</h3>
        <div class="form-group">
            <label for="username">Username:</label>
            <input class="form-control" id="username" />
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" class="form-control" id="password" />
        </div>
        <div class="panel-body">
            <button id="loginBtn" class="btn btn-sm btn-success">Login</button>
            <button id="registerBtn" class="btn btn-sm btn-info">Register</button>
        </div>
        <div id="auth-status" style="margin-top:10px;"></div>
    </div>

    <!-- Форма событий -->
    <form name="eventForm" id="eventForm" class="event-form" style="display: none;">
        <input type="hidden" name="id" value="0" />
        <div class="form-group">
            <label for="theme">Theme:</label>
            <input class="form-control" name="theme" />
        </div>
        <div class="form-group">
            <label for="comment">Comment:</label>
            <input class="form-control" name="comment" />
        </div>
        <div class="form-group">
            <label for="date">Date:</label>
            <input type="datetime-local" class="form-control form-control__date" name="date" />
        </div>
        <div class="form-group">
            <label for="favorite" class="form-label__checkbox">Favorite</label>
            <input type="checkbox" class="form-control form-control__checkbox" name="favorite" />
        </div>
        <div class="form-group">
            <label for="archive" class="form-label__checkbox">Archive</label>
            <input type="checkbox" class="form-control form-control__checkbox" name="archive" />
        </div>
        <div class="panel-body">
            <button type="submit" class="btn btn-sm btn-primary">Save</button>
            <a id="reset" class="btn btn-sm btn-primary">Reset</a>
        </div>
    </form>

    <!-- Таблица событий -->
    <table class="table table-condensed table-striped table-bordered" style="display: none;">
        <thead><tr><th>Id</th><th>Theme</th><th>Comment</th><th>Date</th><th>F</th><th>A</th><th></th></tr></thead>
        <tbody></tbody>
    </table>

    <!-- Кнопка выхода -->
    <div class="event-form" style="display: none;" id="logout-block">
        <button id="logoutBtn" class="btn btn-sm btn-danger">Logout</button>
    </div>

    <!-- Скрипт -->
    <script>
        let authToken = localStorage.getItem("token") || "";

        const authBlock = document.getElementById("auth-block");
        const eventForm = document.getElementById("eventForm");
        const eventTable = document.querySelector("table");
        const logoutBlock = document.getElementById("logout-block");

        if (!authToken) {
            authBlock.style.display = "block";
        } else {
            authBlock.style.display = "none";
            eventForm.style.display = "block";
            eventTable.style.display = "table";
            logoutBlock.style.display = "block";
            GetEvents();
        }

        document.getElementById("loginBtn").addEventListener("click", async () => {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const res = await fetch("/api/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (res.ok) {
                authToken = data.token;
                localStorage.setItem("token", authToken);
                document.getElementById("auth-status").textContent = "Login successful!";
                authBlock.style.display = "none";
                eventForm.style.display = "block";
                eventTable.style.display = "table";
                logoutBlock.style.display = "block";
                GetEvents();
            } else {
                document.getElementById("auth-status").textContent = data.message || "Login failed";
            }
        });

        document.getElementById("registerBtn").addEventListener("click", async () => {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const res = await fetch("/api/auth/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (res.ok) {
                document.getElementById("auth-status").textContent = "Registration successful!";
            } else {
                document.getElementById("auth-status").textContent = data.message || "Registration failed";
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("token");
            location.reload();
        });

        async function GetEvents() {
            const response = await fetch("/api/events", {
                method: "GET",
                headers: {
                    "Accept": "application/json",
                    "Authorization": "Bearer " + authToken
                }
            });
            if (response.ok === true) {
                const events = await response.json();
                let rows = document.querySelector("tbody");
                rows.innerHTML = "";
                events.forEach(event => {
                    rows.append(row(event));
                });
            }
        }

        async function GetEvent(id) {
            const response = await fetch("/api/events/" + id, {
                method: "GET",
                headers: {
                    "Accept": "application/json",
                    "Authorization": "Bearer " + authToken
                }
            });
            if (response.ok === true) {
                const event = await response.json();
                const form = document.forms["eventForm"];
                form.elements["id"].value = event._id;
                form.elements["theme"].value = event.theme;
                form.elements["comment"].value = event.comment;
                form.elements["date"].value = event.date;
                form.elements["favorite"].checked = event.favorite;
                form.elements["archive"].checked = event.archive;
            }
        }

        async function CreateEvent(theme, comment, date, favorite, archive) {
            const response = await fetch("/api/events", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + authToken
                },
                body: JSON.stringify({ theme, comment, date, favorite, archive })
            });
            if (response.ok === true) {
                const event = await response.json();
                reset();
                document.querySelector("tbody").append(row(event));
            }
        }

        async function EditEvent(id, theme, comment, date, favorite, archive) {
            const response = await fetch("/api/events", {
                method: "PUT",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + authToken
                },
                body: JSON.stringify({ id, theme, comment, date, favorite, archive })
            });
            if (response.ok === true) {
                const event = await response.json();
                reset();
                document.querySelector("tr[data-rowid='" + event._id + "']").replaceWith(row(event));
            }
        }

        async function DeleteEvent(id) {
            const response = await fetch("/api/events/" + id, {
                method: "DELETE",
                headers: {
                    "Accept": "application/json",
                    "Authorization": "Bearer " + authToken
                }
            });
            if (response.ok === true) {
                const event = await response.json();
                document.querySelector("tr[data-rowid='" + event._id + "']").remove();
            }
        }

        function reset() {
            const form = document.forms["eventForm"];
            form.reset();
            form.elements["id"].value = 0;
        }

        function row(event) {
            const tr = document.createElement("tr");
            tr.setAttribute("data-rowid", event._id);

            tr.innerHTML = `
                <td>${event._id}</td>
                <td>${event.theme}</td>
                <td>${event.comment}</td>
                <td>${event.date}</td>
                <td>${event.favorite}</td>
                <td>${event.archive}</td>
                <td>
                    <a href="#" data-id="${event._id}" class="edit-link" style="padding:15px;">Change</a>
                    <a href="#" data-id="${event._id}" class="delete-link" style="padding:15px;color:#FF0000">Delete</a>
                </td>
            `;

            tr.querySelector(".edit-link").addEventListener("click", e => {
                e.preventDefault();
                GetEvent(event._id);
            });
            tr.querySelector(".delete-link").addEventListener("click", e => {
                e.preventDefault();
                DeleteEvent(event._id);
            });

            return tr;
        }

        document.getElementById("reset").addEventListener("click", e => {
            e.preventDefault();
            reset();
        });

        document.forms["eventForm"].addEventListener("submit", e => {
            e.preventDefault();
            const form = document.forms["eventForm"];
            const id = form.elements["id"].value;
            const theme = form.elements["theme"].value;
            const comment = form.elements["comment"].value;
            const date = form.elements["date"].value || new Date().toISOString();
            const favorite = form.elements["favorite"].checked;
            const archive = form.elements["archive"].checked;
            if (id == 0)
                CreateEvent(theme, comment, date, favorite, archive);
            else
                EditEvent(id, theme, comment, date, favorite, archive);
        });
    </script>
</body>
</html>
